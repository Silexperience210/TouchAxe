name: Build and Release Firmware

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
          
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: Build firmware
      run: |
        pio run
        
    - name: Prepare firmware files
      run: |
        mkdir -p firmware_release
        cp .pio/build/esp32-4827S043C/bootloader.bin firmware_release/
        cp .pio/build/esp32-4827S043C/partitions.bin firmware_release/
        cp .pio/build/esp32-4827S043C/firmware.bin firmware_release/
        cp ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin firmware_release/
        
    - name: Create manifest.json
      run: |
        cat > firmware_release/manifest.json << 'EOF'
        {
          "name": "TouchAxe Mining Dashboard",
          "version": "${{ github.ref_name }}",
          "funding_url": "https://github.com/${{ github.repository }}",
          "new_install_prompt_erase": true,
          "builds": [
            {
              "chipFamily": "ESP32-S3",
              "parts": [
                { "path": "bootloader.bin", "offset": 4096 },
                { "path": "partitions.bin", "offset": 32768 },
                { "path": "boot_app0.bin", "offset": 57344 },
                { "path": "firmware.bin", "offset": 65536 }
              ]
            }
          ]
        }
        EOF
        
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: firmware_release/
        
    - name: Update firmware folder
      run: |
        rm -rf firmware/*
        cp firmware_release/* firmware/
        
    - name: Display firmware info
      run: |
        echo "Firmware built successfully!"
        ls -lh firmware/
        echo "---"
        cat firmware/manifest.json

    - name: Commit firmware to repository
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add firmware/
        git diff --staged --quiet || git commit -m "Auto-update firmware binaries [skip ci]"
        git push

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          firmware_release/bootloader.bin
          firmware_release/partitions.bin
          firmware_release/boot_app0.bin
          firmware_release/firmware.bin
          firmware_release/manifest.json
        body: |
          ## TouchAxe Firmware ${{ github.ref_name }}
          
          ### Installation
          
          **Web Flasher** (Easiest):
          Visit https://${{ github.repository_owner }}.github.io/TouchAxe/ and click "Install Firmware"
          
          **Manual Flash** (Advanced):
          ```bash
          esptool.py --chip esp32s3 --port COM_PORT write_flash \
            0x1000 bootloader.bin \
            0x8000 partitions.bin \
            0xe000 boot_app0.bin \
            0x10000 firmware.bin
          ```
          
          ### What's New
          - Check the [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})
          
          ### Requirements
          - ESP32-S3 with 480Ã—272 touchscreen (esp32-4827S043C or compatible)
          - Chrome, Edge, or Opera browser for web installation
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
